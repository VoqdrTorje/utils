# nRF Cloud Utilities

This repository contains scripts that support certain use cases of nRF Cloud, mainly endpoints in [the Device API](https://api.nrfcloud.com/v1).

The scripts are gathered from various teams and organized according to their programmatic language. We cannot, at this time, offer the same scripts across all languages.

Please see the README in each folder for more information.

## How to obtain the nRF9160's UUID (modem firmware 1.3 and later)

The nRF9160 contains a UUID which can be used as the nRF Cloud device ID (MQTT client ID).

The UUID is found in the device identity attestation token, which is a base64 encoded CBOR object.  To request an attestation token issue the following [AT command](https://infocenter.nordicsemi.com/index.jsp?topic=/ref_at_commands/REF/at_commands/intro.html): `AT%ATTESTTOKEN`

The attestation token must then be decoded/parsed.  This can be done using the [modem_credentials_parser.py](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/modem_credentials_parser.py) python3 script.  See the [README](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/README.md) for additional details.
The UUID will be displayed in the script's output on the line starting with `Dev UUID:`.

To obtain the UUID in your device's application code, use the following library: https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/include/modem/modem_attest_token.html


## Securely generating credentials on the nRF9160 (modem firmware 1.3 and later)

Credentials can be securely generated by the modem using the `KEYGEN` [AT command](https://infocenter.nordicsemi.com/index.jsp?topic=/ref_at_commands/REF/at_commands/intro.html).

1. Ensure that the modem is deactivated by sending AT command: `AT+CFUN=4`
2. To generate a private key in the modem and receive the associated certificate signing request (CSR), execute the following AT command:
	`AT%KEYGEN=<sec_tag>,2,0`
	- `<sec_tag>` is the slot in the modem where the credential will be stored.  The default `<sec_tag>` for nRF Cloud credentials is `16842753`
	- The slot must be empty before generating a new credential.  Use the `CMNG` AT command to view and delete credentials as needed.
	- The above `KEYGEN` command uses the default value [the nRF9160's UUID] for the `CN` in the credential.  If you are using a different device ID/MQTT client ID, update your `KEYGEN` command accordingly.
3. The output of a successful `KEYGEN` command is a base64 encoded CBOR object.  Use [modem_credentials_parser.py](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/modem_credentials_parser.py) to convert that output into a CSR PEM file.  See the [README](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/README.md) for additional details.
4. Use [create-device-cert.ts](https://github.com/nRFCloud/utils/blob/master/node-ts/src/create-device-cert.ts) to create a signed device certificate from the CSR PEM file and a CA certificate.
5.  The signed device certificate can then be provided to the [ProvisionDevices](https://api.nrfcloud.com/v1#operation/ProvisionDevices) endpoint.

At this point, the device has a private key in the `<sec_tag>` provided to the `KEYGEN` command.
To communicate with nRF Cloud it also needs the [AWS CA certificate](https://www.amazontrust.com/repository/AmazonRootCA1.pem).  To write the CA certificate to the device, use the the following AT command:
`AT%CMNG=0,<sec_tag>,0,"<CA_cert_text>"`

Additionally, if the device will use MQTT to connect to nRF Cloud it needs the device certificate generated above.
To write the device certificate to the device, use the the following AT command:
`AT%CMNG=0,<sec_tag>,1,"<device_cert_text>"`

## Generating credentials on a computer

Credentials can be created off-device and later be loaded into the device. This method can be considered less-secure since it exposes the private key.

1. Scripts to generate credentials can be found here: [https://github.com/nRFCloud/utils/tree/master/node-ts](https://github.com/nRFCloud/utils/tree/master/node-ts)
2. The signed device certificate can be provided to the [ProvisionDevices](https://api.nrfcloud.com/v1#operation/ProvisionDevices) endpoint.
3. Follow the steps in the section above to write the CA and device certificates to the device.
4. Since the private key was generated off-device, it must also be written to the device.  To write the private key to the device, use the the following AT command:
`AT%CMNG=0,<sec_tag>,2,"<private_key_text>"`
