# nRF Cloud Utilities

This repository contains scripts that support certain use cases of nRF Cloud, mainly endpoints in [the Device API](https://api.nrfcloud.com/v1).

The scripts are gathered from various teams and organized according to their programmatic language. We cannot, at this time, offer the same scripts across all languages.

Please see the README in each folder for more information.

## How to obtain the nRF9160's UUID
*Requires modem firmware 1.3 and later.*

The nRF9160 contains a UUID which can be used as the [nRF Cloud device ID](https://github.com/nrfconnect/sdk-nrf/blob/master/include/net/nrf_cloud.rst#configuration-options-for-device-id) (MQTT client ID).

The UUID is found in the device identity attestation token, which is a base64 encoded CBOR object.  To request an attestation token issue the following [AT command](https://infocenter.nordicsemi.com/topic/ref_at_commands/REF/at_commands/security/attesttoken_set.html): `AT%ATTESTTOKEN`

The attestation token must then be decoded/parsed.  This can be done using the [modem_credentials_parser.py](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/modem_credentials_parser.py) python3 script.  See the [README](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/README.md) for additional details.
The UUID will be displayed in the script's output on the line starting with `Dev UUID:`.

The output of the `KEYGEN` [AT command](https://infocenter.nordicsemi.com/topic/ref_at_commands/REF/at_commands/security/keygen_set.html) can be similarly parsed using `modem_credentials_parser.py` to display the UUID.

The UUID is also included in JSON Web Tokens (JWTs) generated by the modem.  To generate a JWT, use the [JWT AT command](https://infocenter.nordicsemi.com/topic/ref_at_commands/REF/at_commands/security/jwt.html).  [Decode](https://jwt.io/) the base64 output and the UUID can be found in the payload's `"iss"` claim after "nRF9160.".

To obtain the UUID in your device's application code, use the following library: https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/include/modem/modem_attest_token.html


## Securely generating credentials on the nRF9160
*Requires modem firmware 1.3 and later.*

Credentials can be securely generated by the modem using the `KEYGEN`  [AT command](https://infocenter.nordicsemi.com/topic/ref_at_commands/REF/at_commands/security/keygen_set.html).  This method can be considered more-secure since the private key is not exposed; it never leaves the modem.

1. Ensure that the modem is deactivated by sending AT command: `AT+CFUN=4`

2. To generate a **private key** in the modem and receive the associated **certificate signing request (CSR)**, execute the following AT command:
`AT%KEYGEN=<sec_tag>,2,0`
	-  `<sec_tag>` is the slot in the modem where the credential will be stored. The default `<sec_tag>` for nRF Cloud credentials is `16842753`
	- The slot must be empty before generating a new credential. Use the `CMNG` AT command to view and delete credentials as needed.
	- The above `KEYGEN` command uses the default value [the nRF9160's UUID] for the `CN` in the credential. If you are using a different [device ID/MQTT client ID](https://github.com/nrfconnect/sdk-nrf/blob/master/include/net/nrf_cloud.rst#configuration-options-for-device-id), update your `KEYGEN` command to use the that ID as the `CN` value.

3. The output of a successful `KEYGEN` command is a base64 encoded CBOR object. Use [modem_credentials_parser.py](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/modem_credentials_parser.py) to convert that output into a **CSR PEM** file and a **public key PEM** file. See the [README](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/README.md) for additional details.

4. Use the **CSR PEM** file to create a **device certificate** using [create_device_credentials.py](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3%2B/create_device_credentials.py). See the [README](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/README.md) for additional details.
	-  This step requires a CA certificate (and its private key).  If you do not already have one, use [create_ca_cert.py](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3%2B/create_ca_cert.py) to create a CA and key which can be used to sign all your device certificates.

5. The **device certificate** can then be provided to the [ProvisionDevices](https://api.nrfcloud.com/v1#operation/ProvisionDevices) endpoint. A successful call to `ProvisionDevices` will result in a device which is both provisioned and associated with your nRF Cloud account. Devices that use MQTT or the nRF Cloud FOTA service must be provisioned and associated. If the device does not need to be provisioned but needs to use certain nRF Cloud REST APIs, provide the **public key PEM** file generated above to the [RegisterPublicKeys](https://api.nrfcloud.com/v1#operation/RegisterPublicKeys) endpoint.

6. If the device will use MQTT to connect to nRF Cloud then it needs the **device certificate** generated above. To write the device certificate to the device, use the the following AT command:
`AT%CMNG=0,<sec_tag>,1,"<device_cert_text>"`

	The device now has a **private key** in the `<sec_tag>` provided to the `KEYGEN` command and also a **device certificate**.

7. To communicate with nRF Cloud it also needs the **[AWS CA certificate](https://www.amazontrust.com/repository/AmazonRootCA1.pem)**. To write the **AWS CA certificate** to the device, use the the following AT command:
`AT%CMNG=0,<sec_tag>,0,"<CA_cert_text>"`
8.  The device now has the **AWS CA certificate**, a **private key**, and for MQTT, a **device certificate**.  It is ready to interact with nRF Cloud via REST or MQTT.

Note:
Credentials can be managed using [LTE Link Monitor](https://infocenter.nordicsemi.com/topic/ug_link_monitor/UG/link_monitor/lm_certificate_manager.html) certificate manager UI:

 - Type your `<sec_tag>` into the `Security tag` field.
 - Copy and paste the **AWS CA certificate** into the top box, labeled `CA certificate`.
 - Copy and paste the **device certificate** into the middle box, labeled `Client certificate`.
 - **Do not** input any data into the `Private Key` box.  This would overwrite the key created by `KEYGEN` and you would need to start the process over from step 1.

## Generating credentials on a computer

Credentials can be created off-device and later be loaded into the device. This method can be considered less-secure since it exposes the private key.

1. To create a **device certificate** and a keypair (**public key and private key**), use [create_device_credentials.py](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3%2B/create_device_credentials.py). See the [README](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/README.md) for additional details.  For the `-cn` parameter (Common Name) to `create_device_credentials.py` use your device's nRF Cloud device ID.  If you wish to use the device's internal UUID, see [How to obtain the nRF9160's UUID](#how-to-obtain-the-nrf9160s-uuid).
	-  This step requires a CA certificate (and its private key).  If you do not already have one, use [create_ca_cert.py](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3%2B/create_ca_cert.py) to create a CA and key which can be used to sign all your device certificates.
2. The **device certificate** can then be provided to the [ProvisionDevices](https://api.nrfcloud.com/v1#operation/ProvisionDevices) endpoint. A successful call to `ProvisionDevices` will result in a device which is both provisioned and associated with your nRF Cloud account. Devices that use MQTT or the nRF Cloud FOTA service must be provisioned and associated. If the device does not need to be provisioned but needs to use certain nRF Cloud REST APIs, provide the **public key** generated above to the [RegisterPublicKeys](https://api.nrfcloud.com/v1#operation/RegisterPublicKeys) endpoint.
3. The **private key** must be written to the device so that it can communicate with nRF Cloud via MQTT or REST (for signing JWTs). To write the private key to the device, use the the following AT command:
`AT%CMNG=0,<sec_tag>,2,"<private_key_text>"`
4. If the device will use MQTT to connect to nRF Cloud then it needs the **device certificate** generated above. To write the device certificate to the device, use the the following AT command:
`AT%CMNG=0,<sec_tag>,1,"<device_cert_text>"`
5. To communicate with nRF Cloud it also needs the **[AWS CA certificate](https://www.amazontrust.com/repository/AmazonRootCA1.pem)**. To write the **AWS CA certificate** to the device, use the the following AT command:
`AT%CMNG=0,<sec_tag>,0,"<CA_cert_text>"`
6.  The device now has the **AWS CA certificate**, a **private key**, and for MQTT, a **device certificate**.  It is ready to interact with nRF Cloud via REST or MQTT.

Note:
Credentials can be managed using [LTE Link Monitor](https://infocenter.nordicsemi.com/topic/ug_link_monitor/UG/link_monitor/lm_certificate_manager.html) certificate manager UI:

 - Type your `<sec_tag>` into the `Security tag` field.
 - Copy and paste the **AWS CA certificate** into the top box, labeled `CA certificate`.
 - Copy and paste the **device certificate** into the middle box, labeled `Client certificate`.
 - Copy and paste the **private key** into the bottom box, labeled `Private key`.

If you prefer to use TypeScript instead of Python, see: [https://github.com/nRFCloud/utils/tree/master/node-ts](https://github.com/nRFCloud/utils/tree/master/node-ts)
