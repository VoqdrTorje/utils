
# nRF Cloud Utilities



This repository contains scripts that support certain use cases of nRF Cloud, mainly endpoints in [the Device API](https://api.nrfcloud.com/v1).



The scripts are gathered from various teams and organized according to their programmatic language: [Python](https://github.com/nRFCloud/utils/tree/master/python/modem-firmware-1.3%2B) and [TypeScript](https://github.com/nRFCloud/utils/tree/master/node-ts). We cannot, at this time, offer the same scripts across all languages.

Please see the README in each folder for more information.


## Device Credentials

In order for a device and nRF Cloud to communicate, [credentials](https://docs.paba.nrfcloud.com/Reference/Devices/Security) must be present on the device and on nRF Cloud.  There are multiple ways to generate credentials and provision devices on nRF Cloud.

   * [Generate the private key on the device](https://docs.paba.nrfcloud.com/Guides/GettingStarted/DevicesGSG#securely-generating-credentials-on-the-nrf9160)
	   * More secure, private key is never exposed.
	   * The response from the [KEYGEN](https://infocenter.nordicsemi.com/index.jsp?topic=/ref_at_commands/REF/at_commands/security/keygen_set.html) AT command is retrieved from the device and processed externally.
	   * Public certificates are written to the device using the [CMNG](https://infocenter.nordicsemi.com/index.jsp?topic=/ref_at_commands/REF/at_commands/security/keygen_set.html) AT command.
	   * Provisioning and association: [single API call](https://docs.paba.nrfcloud.com/Reference/DeviceManagement/Provisioning#non-jitp-pre-connect-provisioning).

  * [Generate all credentials on a computer](https://docs.paba.nrfcloud.com/Guides/GettingStarted/DevicesGSG#generating-credentials-on-a-computer)
	  * Less-secure, private key is exposed.
	  * Private key and public certificates are written to the device using the [CMNG](https://infocenter.nordicsemi.com/index.jsp?topic=/ref_at_commands/REF/at_commands/security/keygen_set.html) AT command.
	  * Provisioning and association: [single API call](https://docs.paba.nrfcloud.com/Reference/DeviceManagement/Provisioning#non-jitp-pre-connect-provisioning).

  * [Request JITP credentials from nRF Cloud](https://api.nrfcloud.com/v1#operation/CreateDeviceCertificate)
	  * Less-secure, private key is exposed.
	  * Credentials, per device, are downloaded from nRF Cloud.
	  * Private key and public certificates are written to the device using the [CMNG](https://infocenter.nordicsemi.com/index.jsp?topic=/ref_at_commands/REF/at_commands/security/keygen_set.html) AT command.
	  * Provisioning and association: [multiple API calls/device interaction required](https://docs.paba.nrfcloud.com/Reference/DeviceManagement/Provisioning#just-in-time-provisioning-jitp).


## How to obtain the nRF9160's UUID

*Requires modem firmware 1.3 and later.*



The nRF9160 contains a UUID which can be used as the [nRF Cloud device ID](https://github.com/nrfconnect/sdk-nrf/blob/master/include/net/nrf_cloud.rst#configuration-options-for-device-id) (MQTT client ID).



The UUID is found in the device identity attestation token, which is a base64 encoded CBOR object. To request an attestation token issue the following [AT command](https://infocenter.nordicsemi.com/topic/ref_at_commands/REF/at_commands/security/attesttoken_set.html): `AT%ATTESTTOKEN`



The attestation token must then be decoded/parsed. This can be done using the [modem_credentials_parser.py](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/modem_credentials_parser.py) python3 script. See the [README](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/README.md) for additional details.

The UUID will be displayed in the script's output on the line starting with `Dev UUID:`.



The output of the `KEYGEN`  [AT command](https://infocenter.nordicsemi.com/topic/ref_at_commands/REF/at_commands/security/keygen_set.html) can be similarly parsed using `modem_credentials_parser.py` to display the UUID.



The UUID is also included in JSON Web Tokens (JWTs) generated by the modem. To generate a JWT, use the [JWT AT command](https://infocenter.nordicsemi.com/topic/ref_at_commands/REF/at_commands/security/jwt.html). [Decode](https://jwt.io/) the base64 output and the UUID can be found in the payload's `"iss"` claim after "nRF9160.".



To obtain the UUID in your device's application code, use the [Modem Attestation Token library](http://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/include/modem/modem_attest_token.html#c.modem_attest_token_get_uuids) or the [Modem JWT library](http://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/include/modem/modem_jwt.html#c.modem_jwt_get_uuids).




## Securely generating credentials on the nRF9160

*Requires modem firmware 1.3 and later.*



Credentials can be securely generated by the modem using the `KEYGEN`  [AT command](https://infocenter.nordicsemi.com/topic/ref_at_commands/REF/at_commands/security/keygen_set.html). This method can be considered more-secure since the private key is not exposed; it never leaves the modem.



1. Ensure that the modem is deactivated by sending AT command: `AT+CFUN=4`



2. To generate a **private key** in the modem and receive the associated **certificate signing request (CSR)**, execute the following AT command:

`AT%KEYGEN=<sec_tag>,2,0`

- `<sec_tag>` is the slot in the modem where the credential will be stored. The default `<sec_tag>` for nRF Cloud credentials is `16842753`

- The slot must be empty before generating a new credential. Use the `CMNG` AT command to view and delete credentials as needed.

- The above `KEYGEN` command uses the default value [the nRF9160's UUID] for the `CN` in the credential. If you are using a different [device ID/MQTT client ID](https://github.com/nrfconnect/sdk-nrf/blob/master/include/net/nrf_cloud.rst#configuration-options-for-device-id), update your `KEYGEN` command to use the that ID as the `CN` value.



3. The output of a successful `KEYGEN` command is a base64 encoded CBOR object. Use [modem_credentials_parser.py](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/modem_credentials_parser.py) to convert that output into a **CSR PEM** file and a **public key PEM** file. See the [README](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/README.md) for additional details.



4. Use the **CSR PEM** file to create a **device certificate** using [create_device_credentials.py](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3%2B/create_device_credentials.py). See the [README](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/README.md) for additional details.

- This step requires a CA certificate (and its private key). If you do not already have one, use [create_ca_cert.py](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3%2B/create_ca_cert.py) to create a CA and key which can be used to sign all your device certificates.



5. The **device certificate** can then be provided to the [ProvisionDevices](https://api.nrfcloud.com/v1#operation/ProvisionDevices) endpoint. A successful call to `ProvisionDevices` will result in a device which is both provisioned and associated with your nRF Cloud account. Devices that use MQTT or the nRF Cloud FOTA service must be provisioned and associated. If the device does not need to be provisioned but needs to use certain nRF Cloud REST APIs, provide the **public key PEM** file generated above to the [RegisterPublicKeys](https://api.nrfcloud.com/v1#operation/RegisterPublicKeys) endpoint.



6. If the device will use MQTT to connect to nRF Cloud then it needs the **device certificate** generated above. Write the **device certificate** to your device, using the same `<sec_tag>` used for the `KEYGEN` command. See [Managing and Flashing Credentials](#managing-and-flashing-credentials) for details.


The device now has a **private key** in the `<sec_tag>` provided to the `KEYGEN` command and also a **device certificate**.



7. To communicate with nRF Cloud it also needs the **[AWS CA certificate](https://www.amazontrust.com/repository/AmazonRootCA1.pem)**.  [Write](#managing-and-flashing-credentials) the **CA certificate** to your device, using the same `<sec_tag>` used for the `KEYGEN` command.

8. The device now has the **AWS CA certificate**, a **private key**, and for MQTT, a **device certificate**. It is ready to interact with nRF Cloud via REST or MQTT.

## Generating credentials on a computer



Credentials can be created off-device and later be loaded into the device. This method can be considered less-secure since it exposes the private key.



1. To create a **device certificate** and a keypair (**public key and private key**), use [create_device_credentials.py](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3%2B/create_device_credentials.py). See the [README](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3+/README.md) for additional details. For the `-cn` parameter (Common Name) to `create_device_credentials.py` use your device's nRF Cloud device ID. If you wish to use the device's internal UUID, see [How to obtain the nRF9160's UUID](#how-to-obtain-the-nrf9160s-uuid).

- This step requires a CA certificate (and its private key). If you do not already have one, use [create_ca_cert.py](https://github.com/nRFCloud/utils/blob/master/python/modem-firmware-1.3%2B/create_ca_cert.py) to create a CA and key which can be used to sign all your device certificates.

2. The **device certificate** can then be provided to the [ProvisionDevices](https://api.nrfcloud.com/v1#operation/ProvisionDevices) endpoint. A successful call to `ProvisionDevices` will result in a device which is both provisioned and associated with your nRF Cloud account. Devices that use MQTT or the nRF Cloud FOTA service must be provisioned and associated. If the device does not need to be provisioned but needs to use certain nRF Cloud REST APIs, provide the **public key** generated above to the [RegisterPublicKeys](https://api.nrfcloud.com/v1#operation/RegisterPublicKeys) endpoint.

3. The **private key** must be written to the device so that it can communicate with nRF Cloud via MQTT (for mTLS) or REST (for signing JWTs). Write the **private key** to your device using the the desired `<sec_tag>`; typically `16842753` for nRF Cloud. See [Managing and Flashing Credentials](#managing-and-flashing-credentials) for details.

4. If the device will use MQTT to connect to nRF Cloud then it needs the **device certificate** generated above. [Write](#managing-and-flashing-credentials) the **device certificate** to your device, using the same `<sec_tag>` as above.

5. To communicate with nRF Cloud it also needs the **[AWS CA certificate](https://www.amazontrust.com/repository/AmazonRootCA1.pem)**. [Write](#managing-and-flashing-credentials) the **CA certificate** to your device, using the same `<sec_tag>` as above.

6. The device now has the **AWS CA certificate**, a **private key**, and for MQTT, a **device certificate**. It is ready to interact with nRF Cloud via REST or MQTT.


## Managing and Flashing Credentials
Credentials are managed using the  `CMNG`  [AT command](https://infocenter.nordicsemi.com/topic/ref_at_commands/REF/at_commands/security/cmng.html).

 - **Writing a CA Certificate**
`AT%CMNG=0,<sec_tag>,0,"<CA_cert_text>"`

 - **Writing a Device Certificate**
`AT%CMNG=0,<sec_tag>,1,"<device_cert_text>"`

 -  **Writing a Private Key**
`AT%CMNG=0,<sec_tag>,2,"<private_key_text>"`

Credentials can also be managed using [LTE Link Monitor](https://infocenter.nordicsemi.com/topic/ug_link_monitor/UG/link_monitor/lm_certificate_manager.html) certificate manager UI:

- Type your `<sec_tag>` into the `Security tag` field.

- Copy and paste the **CA certificate** into the top box, labeled `CA certificate`.

- Copy and paste the **device certificate** into the middle box, labeled `Client certificate`.

- Copy and paste the **private key** into the bottom box, labeled `Private key`.
	- NOTE:  If `KEYGEN` was used to generate a private key, **do not** input any data into the `Private Key` box. This would overwrite the key created by `KEYGEN` and you would need to start the process over.
